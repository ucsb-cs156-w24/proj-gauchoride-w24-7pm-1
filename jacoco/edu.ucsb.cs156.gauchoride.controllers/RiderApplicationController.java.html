<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RiderApplicationController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">GauchoRide</a> &gt; <a href="index.source.html" class="el_package">edu.ucsb.cs156.gauchoride.controllers</a> &gt; <span class="el_source">RiderApplicationController.java</span></div><h1>RiderApplicationController.java</h1><pre class="source lang-java linenums">package edu.ucsb.cs156.gauchoride.controllers;

import edu.ucsb.cs156.gauchoride.entities.RiderApplication;
import edu.ucsb.cs156.gauchoride.errors.EntityNotFoundException;
import edu.ucsb.cs156.gauchoride.repositories.RiderApplicationRepository;

import io.swagger.v3.oas.annotations.tags.Tag;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.oauth2.jwt.NimbusReactiveJwtDecoder.SecretKeyReactiveJwtDecoderBuilder;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import javax.validation.Valid;

import java.sql.Date;
import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;


@Tag(name = &quot;Rider Application&quot;)
@RequestMapping(&quot;/api&quot;)
@RestController

<span class="fc" id="L37">public class RiderApplicationController extends ApiController {</span>

    @Autowired
    RiderApplicationRepository riderApplicationRepository;
    

    // // Endpoints for ROLE_MEMBER

    //Endpoints for members
    @Operation(summary = &quot;Create a new rider application with the current user as the requester&quot;)
    @PreAuthorize(&quot;hasRole('ROLE_MEMBER')&quot;)
    @PostMapping(&quot;/riderApplication/new&quot;)
    public RiderApplication postRiderApplication(
        @Parameter(name=&quot;perm_number&quot;, description=&quot;String, Perm number consisting of 7 characters&quot;, example = &quot;1234567&quot;, required = true) 
        @RequestParam String perm_number,
        @Parameter(name=&quot;description&quot;, description=&quot;String, Please describe the mobility limitations that cause you to need to use the Gauchoride service. &quot;, example = &quot;My legs are broken&quot;, required = true) 
        @RequestParam String description
    )
    {
<span class="fc" id="L56">        RiderApplication riderApplication = new RiderApplication();</span>
        // Get the current date
<span class="fc" id="L58">        LocalDate localDate = LocalDate.now();</span>
<span class="fc" id="L59">        Date currentDate = Date.valueOf(localDate);</span>

<span class="fc" id="L61">        riderApplication.setStatus(&quot;pending&quot;);</span>
<span class="fc" id="L62">        riderApplication.setUserId(getCurrentUser().getUser().getId());</span>
<span class="fc" id="L63">        riderApplication.setPerm_number(perm_number);</span>
<span class="fc" id="L64">        riderApplication.setCreated_date(currentDate);</span>
<span class="fc" id="L65">        riderApplication.setUpdated_date(currentDate);</span>
<span class="fc" id="L66">        riderApplication.setDescription(description);</span>
<span class="fc" id="L67">        riderApplication.setNotes(&quot;&quot;);</span>
<span class="fc" id="L68">        riderApplication.setEmail(getCurrentUser().getUser().getEmail());</span>

<span class="fc" id="L70">        RiderApplication savedApplication = riderApplicationRepository.save(riderApplication);</span>
<span class="fc" id="L71">        return savedApplication;</span>
    };

    @Operation(summary = &quot;Get all rider requests owned by the current user&quot;)
    @PreAuthorize(&quot;hasRole('ROLE_MEMBER')&quot;)
    @GetMapping(&quot;/rider&quot;)
    public Iterable&lt;RiderApplication&gt; allApplications()
    {
        Iterable&lt;RiderApplication&gt; applications;
<span class="fc" id="L80">        applications = riderApplicationRepository.findAllByUserId(getCurrentUser().getUser().getId());</span>
<span class="fc" id="L81">        return applications;</span>
    };

    @Operation(summary = &quot;Get a single rider application but only if owned by the current user&quot;)
    @PreAuthorize(&quot;hasRole('ROLE_MEMBER')&quot;)
    @GetMapping(&quot;/riderApplication&quot;)
    public RiderApplication getById(
                    @Parameter(name=&quot;id&quot;, description = &quot;Long, Id of the RiderApplication to get&quot;, 
                    required = true)  
                    @RequestParam Long id)
    {
        RiderApplication application;
<span class="fc" id="L93">        application = riderApplicationRepository.findByIdAndUserId(id, getCurrentUser().getUser().getId())</span>
<span class="fc" id="L94">                    .orElseThrow(() -&gt; new EntityNotFoundException(RiderApplication.class, id));</span>
<span class="fc" id="L95">        return application;</span>
    };    

    @Operation(summary = &quot;Edit an existing rider application but only if it is owned by the current user and the application is in the correct status&quot;)
    @PreAuthorize(&quot;hasRole('ROLE_MEMBER')&quot;)
    @PutMapping(&quot;/riderApplication&quot;)
    public ResponseEntity&lt;Object&gt; updateApplication(
                            @Parameter(name=&quot;id&quot;, description=&quot;long, Id of the Application to be edited&quot;, 
                            required = true)
                            @RequestParam Long id,
                            @RequestBody @Valid RiderApplication incoming)
    {
        RiderApplication application;

<span class="fc" id="L109">        application = riderApplicationRepository.findByIdAndUserId(id, getCurrentUser().getUser().getId())</span>
<span class="fc" id="L110">                    .orElseThrow(() -&gt; new EntityNotFoundException(RiderApplication.class, id));</span>

<span class="fc bfc" id="L112" title="All 2 branches covered.">        if (&quot;pending&quot;.equals(application.getStatus()))</span>
        {
            // Get the current date
<span class="fc" id="L115">            LocalDate localDate = LocalDate.now();</span>
<span class="fc" id="L116">            Date currentDate = Date.valueOf(localDate);</span>

<span class="fc" id="L118">            application.setPerm_number(incoming.getPerm_number());</span>
<span class="fc" id="L119">            application.setUpdated_date(currentDate);</span>
<span class="fc" id="L120">            application.setDescription(incoming.getDescription());</span>
<span class="fc" id="L121">            application.setNotes(incoming.getNotes());</span>
<span class="fc" id="L122">            application.setStatus(incoming.getStatus());</span>
<span class="fc" id="L123">            riderApplicationRepository.save(application);</span>
<span class="fc" id="L124">            return ResponseEntity.ok(application);</span>
        } 
<span class="fc bfc" id="L126" title="All 2 branches covered.">        else if (&quot;accepted&quot;.equals(application.getStatus()))</span>
        {
            // Get the current date
<span class="fc" id="L129">            LocalDate localDate = LocalDate.now();</span>
<span class="fc" id="L130">            Date currentDate = Date.valueOf(localDate);</span>

<span class="fc" id="L132">            application.setPerm_number(incoming.getPerm_number());</span>
<span class="fc" id="L133">            application.setUpdated_date(currentDate);</span>
<span class="fc" id="L134">            application.setDescription(incoming.getDescription());</span>
<span class="fc" id="L135">            application.setNotes(incoming.getNotes());</span>
<span class="fc" id="L136">            application.setStatus(incoming.getStatus());</span>
<span class="fc" id="L137">            riderApplicationRepository.save(application);</span>
<span class="fc" id="L138">            return ResponseEntity.ok(application);</span>
        } 
        else
        {
<span class="fc" id="L142">            String errorMessage = &quot;RiderApplication with \&quot;&quot; + application.getStatus() + &quot;\&quot; status cannot be updated&quot;;</span>
<span class="fc" id="L143">            return ResponseEntity.badRequest().body(errorMessage);</span>
        }
    }; 

    @Operation(summary = &quot;Cancel an existing rider application but only if it is owned by the current user and the application is in the correct status&quot;)
    @PreAuthorize(&quot;hasRole('ROLE_MEMBER')&quot;)
    @PutMapping(&quot;/riderApplication/cancel&quot;)
    public Object cancelApplication(
                            @Parameter(name=&quot;id&quot;, description=&quot;long, Id of the Application to be edited&quot;, 
                            required = true)
                            @RequestParam Long id)
                            
    {
        RiderApplication application;

<span class="fc" id="L158">        application = riderApplicationRepository.findByIdAndUserId(id, getCurrentUser().getUser().getId())</span>
<span class="fc" id="L159">                    .orElseThrow(() -&gt; new EntityNotFoundException(RiderApplication.class, id));</span>
        
<span class="fc bfc" id="L161" title="All 2 branches covered.">        if (&quot;pending&quot;.equals(application.getStatus()))</span>
        {
            // Get the current date
<span class="fc" id="L164">            LocalDate localDate = LocalDate.now();</span>
<span class="fc" id="L165">            Date currentDate = Date.valueOf(localDate);</span>

<span class="fc" id="L167">            application.setStatus(&quot;cancelled&quot;);</span>
<span class="fc" id="L168">            application.setUpdated_date(currentDate);</span>
<span class="fc" id="L169">            application.setCancelled_date(currentDate);</span>
<span class="fc" id="L170">            riderApplicationRepository.save(application);</span>

<span class="fc" id="L172">            return genericMessage(&quot;Application with id %s is cancelled&quot;.formatted(id));</span>
        }
        else
        {
<span class="fc" id="L176">            return genericMessage(&quot;Application with \&quot;%s\&quot; status cannot be cancelled&quot;.formatted(application.getStatus()));</span>
        }
    };


    // // Endpoints for ROLE_ADMIN

    @Operation(summary = &quot;Get all rider applications&quot;)
    @PreAuthorize(&quot;hasRole('ROLE_ADMIN')&quot;)
    @GetMapping(&quot;/rider/admin/all&quot;)
    public Iterable&lt;RiderApplication&gt; allApplicationsAdmin()
    {
        Iterable&lt;RiderApplication&gt; applications;
<span class="fc" id="L189">        applications = riderApplicationRepository.findAll();</span>
<span class="fc" id="L190">        return applications;</span>
    };

    @Operation(summary = &quot;Get all pending rider applications&quot;)
    @PreAuthorize(&quot;hasRole('ROLE_ADMIN')&quot;)
    @GetMapping(&quot;/rider/admin/pending&quot;)
    public Iterable&lt;RiderApplication&gt; allPendingApplications()
    {
        Iterable&lt;RiderApplication&gt; pendingApplications;
<span class="fc" id="L199">        pendingApplications = riderApplicationRepository.findAllByStatus(&quot;pending&quot;);</span>

<span class="fc" id="L201">        return pendingApplications;</span>
    };

    @Operation(summary = &quot;Get a specific rider application&quot;)
    @PreAuthorize(&quot;hasRole('ROLE_ADMIN')&quot;)
    @GetMapping(&quot;/rider/admin&quot;)
    public RiderApplication specificApplication(
                            @Parameter(name=&quot;id&quot;, description=&quot;long, Id of the Application to find&quot;, 
                            required = true)
                            @RequestParam Long id)
    {
        RiderApplication application;
<span class="fc" id="L213">        application = riderApplicationRepository.findById(id)</span>
<span class="fc" id="L214">                .orElseThrow(() -&gt; new EntityNotFoundException(RiderApplication.class, id));</span>
<span class="fc" id="L215">        return application;</span>
    };

    @Operation(summary = &quot;Update the status/notes field of an application&quot;)
    @PreAuthorize(&quot;hasRole('ROLE_ADMIN')&quot;)
    @PutMapping(&quot;/rider/admin&quot;)
    public RiderApplication updateApplicationAdmin(
                            @Parameter(name=&quot;id&quot;, description=&quot;long, Id of the Application to be updated&quot;, 
                            required = true)
                            @RequestParam Long id,

                            @Parameter(name=&quot;status&quot;, description=&quot;String, New Status of the Application&quot;, 
                                        required = false)
                            @RequestParam String status,

                            @Parameter(name=&quot;notes&quot;, description=&quot;String, Notes to notify the Applicant&quot;, 
                                        required = false)
                            @RequestParam String notes)
    {
        RiderApplication application;
<span class="fc" id="L235">        application = riderApplicationRepository.findById(id)</span>
<span class="fc" id="L236">                .orElseThrow(() -&gt; new EntityNotFoundException(RiderApplication.class, id));</span>

<span class="fc bfc" id="L238" title="All 2 branches covered.">        if (!status.isEmpty())</span>
        {
<span class="fc" id="L240">            application.setStatus(status);</span>
        }

<span class="fc bfc" id="L243" title="All 2 branches covered.">        if (!notes.isEmpty())</span>
        {
<span class="fc" id="L245">            application.setNotes(notes);</span>
        }      
        
<span class="fc" id="L248">        riderApplicationRepository.save(application);</span>
<span class="fc" id="L249">        return application;</span>
    };

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>